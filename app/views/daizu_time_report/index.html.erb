<script src="/javascripts/calendar/calendar.js" type="text/javascript"></script>
<script src="/javascripts/calendar/lang/calendar-ja.js" type="text/javascript"></script>
<script src="/javascripts/calendar/calendar-setup.js" type="text/javascript"></script>
<link href="/stylesheets/calendar.css" media="screen" rel="stylesheet" type="text/css" />

<h2><%= link_to h('大豆トップページ'), :controller => 'daizu_main', :action => 'index' %> ＞ タイムレポート</h2>

<% form_tag({ :controller => 'daizu_time_report', :action => 'index' }, :id => 'query_form') do %>
  <p><label for="project_id">プロジェクト</label>
  <select name="project_id">
    <option value="all">全てのプロジェクト</option>
    <% @projects.each do |project| %>
      <option value="<%= project.id %>"><%= project.name %></option>
    <% end %>
  </select>
  
  <p><label for="issue_start_date">開始日</label>
  <input id="issue_start_date" name="start_date" size="15" type="text" value="<%= params[:start_date] %>" />
  <img alt="Calendar" class="calendar-trigger" id="issue_start_date_trigger" src="/images/calendar.png" />
  <script type="text/javascript">
  //<![CDATA[
  Calendar.setup({inputField : 'issue_start_date', ifFormat : '%Y-%m-%d', button : 'issue_start_date_trigger' });
  //]]>
  </script></p>

  <p><label for="issue_due_date">期限日</label>
  <input id="issue_due_date" name="due_date" size="15" type="text" value="<%= params[:due_date] %>" />
  <img alt="Calendar" class="calendar-trigger" id="issue_due_date_trigger" src="/images/calendar.png" />
  <script type="text/javascript">
  //<![CDATA[
  Calendar.setup({inputField : 'issue_due_date', ifFormat : '%Y-%m-%d', button : 'issue_due_date_trigger' });
  //]]>
  </script></p>

  <button type="submit">GO</button>
<% end %>

<% if @results %>
  <p>[from:<%= params[:start_date] %> to:<%= params[:due_date] %>] のタイムレポート。</p>

  <table class="list">
    <tr>
      <th></th>
      <% @trackers.each do |tracker| %>
        <th colspan="3" ><%= tracker.name %></th>
      <% end %>
    </tr>
    <tr>
      <th></th>
      <% @trackers.each do |tracker| %>
        <th>予想</th>
        <th>実績</th>
        <th>進捗</th>
      <% end %>
    </tr>
    <tr>
      <th><%= @results[0].project_name %></th>
      <% @trackers.each do |tracker| %>
        <td><%= @results[0].get_tracker(tracker.name).estimated_hours %></td>
        <td><%= @results[0].get_tracker(tracker.name).actual_performances %></td>
        <td>
          <table class="progress" style="width: 40px;">
            <tr>
              <% if @results[0].get_tracker(tracker.name).percentages == 0 %>
                <td class="todo" style="width:100%;"></td>
              <% elsif @results[0].get_tracker(tracker.name).percentages == 100 %>
                <td class="closed" style="width:100%;"></td>
              <% elsif @results[0].get_tracker(tracker.name).percentages > 100 %>
                <td style="width:100%;background-color:red;"></td>
              <% else %>
                <td class="closed" style="<%= "width:" + @results[0].get_tracker(tracker.name).percentages.to_s + "%;" %>"></td>
                <td class="todo" style="<%= "width:" + (100 - @results[0].get_tracker(tracker.name).percentages).to_s + "%;" %>"></td>
              <% end %>
            </tr>
          </table>
          <p class="pourcent"><%= @results[0].get_tracker(tracker.name).percentages.to_s %>%</p>
        </td>
      <% end %>
    </tr>
  </table>

  <% if params[:project_id] != "all" %>

    <h3><%= @results[0].project_name %>の統計情報</h3>

    <!--[if IE]><script src="/plugin_assets/redmine_daizu/javascripts/html5jp/excanvas/excanvas.js" type="text/javascript"></script><![endif]-->
    <script type="text/javascript" src="/plugin_assets/redmine_daizu/javascripts/html5jp/graph/circle.js"></script>
    <script type="text/javascript" src="/plugin_assets/redmine_daizu/javascripts/html5jp/graph/line.js"></script>
    <script type="text/javascript" src="/plugin_assets/redmine_daizu/javascripts/html5jp/graph/vbar.js"></script>
    <script type="text/javascript" src="/plugin_assets/redmine_daizu/javascripts/html5jp/graph/radar.js"></script>
    <script type="text/javascript">
    window.onload = function() {

      // Circle
      var cg = new html5jp.graph.circle("yosou");
      if( ! cg ) { return; }
      var items = [
      <% @trackers.each do |tracker| %>
        <% if tracker.name != "合計" %>
          <% if @results[0].get_tracker(tracker.name).actual_performances != 0.0 %>
            ["<%=tracker.name%>", <%= @results[0].get_tracker(tracker.name).actual_performances %>],
          <% end %>
        <% end %>
      <% end %>
      ];
      cg.draw(items);

      var cg = new html5jp.graph.circle("jisseki");
      if( ! cg ) { return; }
      var items = [
      <% @trackers.each do |tracker| %>
        <% if tracker.name != "合計" %>
          <% if @results[0].get_tracker(tracker.name).estimated_hours != 0.0 %>
            ["<%=tracker.name%>", <%= @results[0].get_tracker(tracker.name).estimated_hours %>],
          <% end %>
        <% end %>
      <% end %>
      ];
      cg.draw(items);

      // Line
      var lg = new html5jp.graph.line("hikaku");
      if( ! lg ) { return; }
      var items = [
      <% @trackers.each do |tracker| %>
        ["<%=tracker.name%>", <%= @results[2].get_tracker(tracker.name).estimated_hours %>, <%= @results[1].get_tracker(tracker.name).estimated_hours %>, <%= @results[0].get_tracker(tracker.name).estimated_hours %>],
      <% end %>
      ];
      var params = {
        x: ["", "前々期間", "前期間", "今回の期間"],
        y: ["時間(h)"],
      };
      lg.draw(items, params);

      var rc = new html5jp.graph.radar("yojitsu");
      if( ! rc ) { return; }
      var items = [
        ["予想", 
          <% @trackers.each do |tracker| %>
            <% if tracker.name != "合計" %>
              <%= @results[0].get_tracker(tracker.name).estimated_hours %>,
            <% end %>
          <% end %>
        ],
        ["実績",
          <% @trackers.each do |tracker| %>
            <% if tracker.name != "合計" %>
              <%= @results[0].get_tracker(tracker.name).actual_performances %>,
            <% end %>
          <% end %>
        ],
      ];
      var params = {
        aCap: [
          <% @trackers.each do |tracker| %>
            "<%= tracker.name %>",
          <% end %>
        ]
      }
      rc.draw(items, params);

    };
    </script>
    
    <table>
      <tr>
        <td style="vertical-align:top;">

          <table>
            <tr>
              <td>
                <h4>予想</h4>
                <div><canvas width="300" height="200" id="yosou"></canvas></div>
              </td>
            </tr>
            <tr>
              <td>
                <h4>実績</h4>
                <div><canvas width="300" height="200" id="jisseki"></canvas></div>
              </td>
            </tr>
          </table>
        </td>
        <td style="vertical-align:top;">
          <h4>予想実績レーダー</h4>
          <div><canvas width="500" height="400" id="yojitsu"></canvas></div>
        </td>
        <td style="vertical-align:top;">
          <h4>期間比較</h4>
          <div><canvas width="300" height="500" id="hikaku"></canvas></div>
        </td>
      </tr>
    </table>

  <% end %>
<% end %>

